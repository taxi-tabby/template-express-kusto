const fs = require('fs');
const path = require('path');

function buildRoutes() {
    console.log(`ğŸ”¨ Scanning routes for webpack build...`);
    
    try {        console.log(`âœ… Routes will be bundled into the virtual file system using routes-map.ts`);
        console.log(`ğŸ“ Source: src/app/routes/`);
        console.log(`ğŸ“ Target: Generated in src/core/tmp/routes-map.ts (temporary)`);
        console.log(`ğŸ“„ Routes will be dynamically imported at runtime`);
          // ì†ŒìŠ¤ ë¼ìš°íŠ¸ íŒŒì¼ ëª©ë¡ í‘œì‹œ
        const sourcePath = 'src/app/routes';
        if (fs.existsSync(sourcePath)) {
            console.log(`ğŸ“Š Source route files:`);
            listFiles(sourcePath, '  ');            
            const routeCount = countRouteFiles(sourcePath);
            console.log(`ğŸ“Š Total route files: ${routeCount.routes}, middleware files: ${routeCount.middlewares}`);
            console.log(`âœ… Route preparation completed. Files will be bundled into the virtual file system.`);
            console.log(`â„¹ï¸ Route map will be generated by the generate-routes-map script.`);
        } else {
            console.warn(`âš ï¸ Source routes directory not found: ${sourcePath}`);
            console.error(`âŒ Cannot proceed with build. Please create the routes directory at: ${sourcePath}`);
            process.exit(1);
        }
        
    } catch (error) {
        console.error(`âŒ Route build preparation failed:`, error.message);
        process.exit(1);
    }
}

function listFiles(dir, prefix = '') {
    if (!fs.existsSync(dir)) return;
    
    const items = fs.readdirSync(dir);
    for (const item of items) {
        const fullPath = path.join(dir, item);
        const stat = fs.statSync(fullPath);
        
        if (stat.isDirectory()) {
            console.log(`${prefix}ğŸ“ ${item}/`);
            listFiles(fullPath, prefix + '  ');
        } else {
            const ext = path.extname(item);
            const icon = ext === '.js' ? 'ğŸ“„' : ext === '.ts' ? 'ğŸ“' : 'ğŸ“„';
            console.log(`${prefix}${icon} ${item} (${formatBytes(stat.size)})`);
        }
    }
}

function countRouteFiles(dir) {
    let routes = 0;
    let middlewares = 0;
    
    function traverse(currentDir) {
        if (!fs.existsSync(currentDir)) return;
        
        const items = fs.readdirSync(currentDir);
        for (const item of items) {
            const fullPath = path.join(currentDir, item);
            const stat = fs.statSync(fullPath);
            
            if (stat.isDirectory()) {
                traverse(fullPath);
            } else if (item.endsWith('.ts') || item.endsWith('.js')) {
                if (item === 'route.ts' || item === 'route.js') routes++;
                if (item === 'middleware.ts' || item === 'middleware.js') middlewares++;
            }
        }
    }
    
    traverse(dir);
    return { routes, middlewares };
}

function formatBytes(bytes) {
    if (bytes < 1024) return `${bytes}B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;
}

// ì‹¤í–‰
buildRoutes();
