name: Auto Release Framework

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  auto-release:
    if: (github.event_name == 'push' || (github.event.pull_request.merged == true)) && github.repository == 'taxi-tabby/express.js-kusto'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Get current version
      id: version_info
      run: |
        # í˜„ì¬ ë²„ì „ ì½ê¸° (ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        echo "package_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
    
    - name: Generate version tag
      id: version
      run: |
        # í˜„ì¬ ë²„ì „ ì‚¬ìš© (ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
        PACKAGE_VERSION="${{ steps.version_info.outputs.package_version }}"
        
        # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ìš©)
        TIMESTAMP=$(date +"%Y.%m.%d-%H%M")
        
        # íƒœê·¸ ìƒì„± (framework-v{package_version})
        TAG_NAME="framework-v${PACKAGE_VERSION}"
        
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "Generated tag: ${TAG_NAME}"
    
    - name: Generate update package
      run: |
        echo "Generating framework update package..."
        npm run updater:generate
    
    - name: Find generated package
      id: package
      run: |
        # ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ íŒ¨í‚¤ì§€ íŒŒì¼ ì°¾ê¸°
        PACKAGE_FILE=$(ls -t updater/packages/update-package-*.zip | head -1)
        
        if [ -z "$PACKAGE_FILE" ] || [ ! -f "$PACKAGE_FILE" ]; then
          echo "No package file found!"
          exit 1
        fi
        
        echo "package_file=${PACKAGE_FILE}" >> $GITHUB_OUTPUT
        echo "Found package: ${PACKAGE_FILE}"
        
        # íŒŒì¼ í¬ê¸° í™•ì¸ (Linux í™˜ê²½)
        FILE_SIZE=$(stat -c%s "$PACKAGE_FILE")
        FILE_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $FILE_SIZE/1024/1024}")
        echo "package_size=${FILE_SIZE_MB}MB" >> $GITHUB_OUTPUT
    
    - name: Find generated map file
      id: mapfile
      run: |
        # ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ ë§µ íŒŒì¼ ì°¾ê¸°
        MAP_FILE=$(ls -t updater/map/v*.json | head -1)
        
        if [ -z "$MAP_FILE" ] || [ ! -f "$MAP_FILE" ]; then
          echo "No map file found!"
          exit 1
        fi
        
        echo "map_file=${MAP_FILE}" >> $GITHUB_OUTPUT
        echo "Found map: ${MAP_FILE}"
        
        # ë§µ íŒŒì¼ì—ì„œ íŒŒì¼ ìˆ˜ ê³„ì‚°
        FILE_COUNT=$(jq 'length' "$MAP_FILE")
        echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
    
    - name: Generate smart release notes
      id: notes
      run: |
        # ì´ì „ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ì°¾ê¸°
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "framework-v" | head -1 || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous release found, using initial commit"
          COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
        else
          echo "Previous release: $PREVIOUS_TAG"
          COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
        fi
        
        # ì»¤ë°‹ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
        COMMITS=$(git log --pretty=format:"- %s (%h)" $COMMIT_RANGE)
        
        # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
        CHANGED_FILES=$(git diff --name-only $COMMIT_RANGE | head -10)
        
        # ìŠ¤ë§ˆíŠ¸ AI ìš”ì•½ ìƒì„± (ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„ ê¸°ë°˜)
        AI_SUMMARY=""
        echo "ğŸ¤– Generating smart summary from commit analysis..."
        
        # ì»¤ë°‹ ë©”ì‹œì§€ í‚¤ì›Œë“œ ë¶„ì„ ë° ìŠ¤ë§ˆíŠ¸ ìš”ì•½ ìƒì„±
        COMMIT_TEXT=$(echo "$COMMITS" | tr '[:upper:]' '[:lower:]')
        
        # ë²„ê·¸ ìˆ˜ì • ê´€ë ¨
        if echo "$COMMIT_TEXT" | grep -qE "(fix|bug|error|crash|issue|problem|resolve)"; then
          AI_SUMMARY="ğŸ› ë²„ê·¸ ìˆ˜ì • ë° ì•ˆì •ì„± ê°œì„  - ì‹œìŠ¤í…œ ì˜¤ë¥˜ í•´ê²° ë° ì•ˆì •ì„± ê°•í™”"
        
        # ìƒˆ ê¸°ëŠ¥ ì¶”ê°€
        elif echo "$COMMIT_TEXT" | grep -qE "(add|new|feature|implement|create|introduce)"; then
          AI_SUMMARY="âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ - í”„ë ˆì„ì›Œí¬ ê¸°ëŠ¥ í™•ì¥ ë° ì‚¬ìš©ì ê²½í—˜ ê°œì„ "
        
        # ì—…ë°ì´íŠ¸ ë° ê°œì„ 
        elif echo "$COMMIT_TEXT" | grep -qE "(update|upgrade|improve|enhance|optimize|performance)"; then
          AI_SUMMARY="ğŸ”„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° ì„±ëŠ¥ ê°œì„  - ìµœì‹  ê¸°ìˆ  ì ìš© ë° íš¨ìœ¨ì„± í–¥ìƒ"
        
        # ë¦¬íŒ©í† ë§
        elif echo "$COMMIT_TEXT" | grep -qE "(refactor|clean|restructure|reorganize|simplify)"; then
          AI_SUMMARY="ğŸ”§ ì½”ë“œ ë¦¬íŒ©í† ë§ ë° êµ¬ì¡° ê°œì„  - ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ ë° ì½”ë“œ í’ˆì§ˆ ê°œì„ "
        
        # ë¬¸ì„œí™”
        elif echo "$COMMIT_TEXT" | grep -qE "(doc|readme|comment|guide|manual)"; then
          AI_SUMMARY="ğŸ“š ë¬¸ì„œí™” ê°œì„  - ì‚¬ìš©ì ê°€ì´ë“œ ë° ì½”ë“œ ë¬¸ì„œ ì—…ë°ì´íŠ¸"
        
        # í…ŒìŠ¤íŠ¸
        elif echo "$COMMIT_TEXT" | grep -qE "(test|spec|coverage|unit|integration)"; then
          AI_SUMMARY="ğŸ§ª í…ŒìŠ¤íŠ¸ ê°•í™” - í’ˆì§ˆ ë³´ì¦ ë° ì•ˆì •ì„± ê²€ì¦ ê°œì„ "
        
        # ì„¤ì • ë° í™˜ê²½
        elif echo "$COMMIT_TEXT" | grep -qE "(config|setup|env|deploy|build|ci|cd)"; then
          AI_SUMMARY="âš™ï¸ ì„¤ì • ë° ë°°í¬ í™˜ê²½ ê°œì„  - ê°œë°œ ë° ìš´ì˜ í™˜ê²½ ìµœì í™”"
        
        # ì˜ì¡´ì„± ê´€ë¦¬
        elif echo "$COMMIT_TEXT" | grep -qE "(dependency|deps|package|npm|yarn|version)"; then
          AI_SUMMARY="ï¿½ ì˜ì¡´ì„± ê´€ë¦¬ ë° íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ - ë¼ì´ë¸ŒëŸ¬ë¦¬ ìµœì‹ í™” ë° ë³´ì•ˆ ê°•í™”"
        
        # ë¦´ë¦¬ì¦ˆ ê´€ë ¨
        elif echo "$COMMIT_TEXT" | grep -qE "(release|version|tag|publish|deploy)"; then
          AI_SUMMARY="ï¿½ ë¦´ë¦¬ì¦ˆ ì¤€ë¹„ ë° ë°°í¬ - ìƒˆ ë²„ì „ ì¶œì‹œ ë° ë°°í¬ í”„ë¡œì„¸ìŠ¤ ê°œì„ "
        
        # ê¸°ë³¸ê°’ (ì»¤ë°‹ ìˆ˜ì— ë”°ë¥¸ ë™ì  ë©”ì‹œì§€)
        else
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          if [ "$COMMIT_COUNT" -gt 10 ]; then
            AI_SUMMARY="ğŸ”§ ëŒ€ê·œëª¨ ì—…ë°ì´íŠ¸ - ë‹¤ì–‘í•œ ê°œì„ ì‚¬í•­ ë° ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ($COMMIT_COUNTê°œ ë³€ê²½ì‚¬í•­)"
          elif [ "$COMMIT_COUNT" -gt 5 ]; then
            AI_SUMMARY="ğŸ”§ ì¤‘ê°„ ê·œëª¨ ì—…ë°ì´íŠ¸ - ì—¬ëŸ¬ ê¸°ëŠ¥ ê°œì„  ë° ìµœì í™” ì‘ì—… ($COMMIT_COUNTê°œ ë³€ê²½ì‚¬í•­)"
          elif [ "$COMMIT_COUNT" -gt 0 ]; then
            AI_SUMMARY="ğŸ”§ ì†Œê·œëª¨ ì—…ë°ì´íŠ¸ - í”„ë ˆì„ì›Œí¬ ìœ ì§€ë³´ìˆ˜ ë° ê°œì„  ì‘ì—… ($COMMIT_COUNTê°œ ë³€ê²½ì‚¬í•­)"
          else
            AI_SUMMARY="ğŸ“¦ Express.js Kusto í”„ë ˆì„ì›Œí¬ ì •ê¸° ë¦´ë¦¬ì¦ˆ"
          fi
        fi
        
        echo "âœ… Smart summary generated: $AI_SUMMARY"
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        {
          echo "# ğŸš€ Express.js Kusto Framework v${{ steps.version.outputs.package_version }}"
          echo ""
          echo "## Summary"
          echo "${AI_SUMMARY}"
          echo ""
          echo "## ğŸ“¦ Package Information"
          echo "- **Framework Version**: v${{ steps.version.outputs.package_version }}"
          echo "- **Build Timestamp**: ${{ steps.version.outputs.timestamp }}"
          echo "- **Package Size**: ${{ steps.package.outputs.package_size }}"
          echo "- **Files Included**: ${{ steps.mapfile.outputs.file_count }} files"
          echo ""
          echo "## ğŸ“ Recent Changes"
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS"
          else
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo ""
          echo "## ğŸ”§ Changed Files (Top 10)"
          echo '```'
          if [ -n "$CHANGED_FILES" ]; then
            echo "$CHANGED_FILES"
          else
            echo "ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo '```'
          echo ""
          echo "---"
          echo "**Generated on**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "**Commit**: ${{ github.sha }}"
          echo "**Workflow**: ${{ github.workflow }}"
        } > release_notes.md
        
        echo "âœ… Smart release notes generated"
    
    - name: Create Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHubì˜ ìë™ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ê¸°ëŠ¥ í™œìš©
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "framework-v" | head -1 || echo "")
        
        # GitHub CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ìƒì„± (ìë™ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í¬í•¨)
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "Creating release with auto-generated notes from $PREVIOUS_TAG"
          gh release create "${{ steps.version.outputs.tag_name }}" \
            --title "Framework v${{ steps.version.outputs.package_version }} (${{ steps.version.outputs.timestamp }})" \
            --notes-file release_notes.md \
            --generate-notes \
            --notes-start-tag "$PREVIOUS_TAG" \
            --target main \
            "${{ steps.package.outputs.package_file }}#express-kusto-framework-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.zip" \
            "${{ steps.mapfile.outputs.map_file }}#file-map-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.json"
        else
          echo "Creating first release with custom notes"
          gh release create "${{ steps.version.outputs.tag_name }}" \
            --title "Framework v${{ steps.version.outputs.package_version }} (${{ steps.version.outputs.timestamp }})" \
            --notes-file release_notes.md \
            --target main \
            "${{ steps.package.outputs.package_file }}#express-kusto-framework-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.zip" \
            "${{ steps.mapfile.outputs.map_file }}#file-map-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.json"
        fi
        
        # ë¦´ë¦¬ì¦ˆ URL ê°€ì ¸ì˜¤ê¸°
        RELEASE_URL=$(gh release view "${{ steps.version.outputs.tag_name }}" --json url --jq .url)
        echo "html_url=${RELEASE_URL}" >> $GITHUB_OUTPUT
    
    - name: Release Summary
      run: |
        echo "ğŸ‰ Release Created Successfully!"
        echo "ğŸ“¦ Release: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ·ï¸ Tag: ${{ steps.version.outputs.tag_name }}"
        echo "ğŸ“ Package: ${{ steps.package.outputs.package_file }} (${{ steps.package.outputs.package_size }})"
        echo "ğŸ“‹ Map File: ${{ steps.mapfile.outputs.map_file }} (${{ steps.mapfile.outputs.file_count }} files)"
        echo "ğŸ“Š Version: v${{ steps.version.outputs.package_version }}"
